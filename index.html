<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard-ระบบการลา</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            padding-top: 20px;
        }
        .container {
            max-width: 960px;
        }
        .card-columns {
            column-count: 1;
        }
        @media (min-width: 768px) {
            .card-columns {
                column-count: 2;
            }
        }
        .card.bg-approval1 {
            background-color: #f3e7ff;
        }
        .card.bg-approval2 {
            background-color: #ffe7f3;
        }
        .card.bg-approval3 {
            background-color: #ffffe7;
        }
        .card.bg-approval4 {
            background-color: #e7ffe7;
        }
        .card.bg-none {
            background-color: white;
        }
        .btn {
            font-size: 12px; /* Smaller font size for all buttons */
            padding: 5px 10px; /* Adjust padding for better fit */
        }
        .btn-approval1 {
            background-color: #f3e7ff;
            color: black;
        }
        .btn-approval2 {
            background-color: #ffe7f3;
            color: black;
        }
        .btn-approval3 {
            background-color: #ffffe7;
            color: black;
        }
        .btn-approval4 {
            background-color: #e7ffe7;
            color: black;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://drive.google.com/thumbnail?id=1biw0LeK_X0ntKPdH4-8XaPUcl1yGDl59" width="110px">
        <h2 class="mb-3">ระบบอนุมัติการลา</h2>
    
        <div class="form-group">
            <label for="courseSelector">เลือกหลักสูตร:</label>
            <select id="courseSelector" class="form-control" onchange="filterByCourse()">
                <option value="">-- แสดงทั้งหมด --</option>
                <option value="หลักสูตรสัญญาบัตร สายวิทยาการการศึกษา">หลักสูตรสัญญาบัตร สายวิทยาการการศึกษา</option>
                <option value="หลักสูตรประทวน สายวิทยาการการศึกษา">หลักสูตรประทวน สายวิทยาการการศึกษา</option>
                <option value="หลักสูตรสัญญาบัตรใหม่">หลักสูตรสัญญาบัตรใหม่</option>
                <option value="หลักสูตรประทวนใหม่">หลักสูตรประทวนใหม่</option>
                <option value="หลักสูตรประทวนอาวุโส">หลักสูตรประทวนอาวุโส</option>
                <option value="หลักสูตรการปฏิบัติการร่วม-A">หลักสูตรการปฏิบัติการร่วม-A</option>
                <option value="หลักสูตรการปฏิบัติการร่วม-B">หลักสูตรการปฏิบัติการร่วม-B</option>
                <option value="หลักสูตรการปฏิบัติการร่วม-C">หลักสูตรการปฏิบัติการร่วม-C</option>
                <option value="หลักสูตรการปฏิบัติการร่วม-D">หลักสูตรการปฏิบัติการร่วม-D</option>
            </select>
        </div>
    
    
        <div id="status" class="alert alert-info">กำลังโหลดข้อมูล โปรดรอสักครู่...</div>
        <div id="dataCards" class="card-columns"></div> </div>

        <div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">รายละเอียดการลา</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p id="modalContent"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxguP0m67T6hDKAkV6ZoXqGurtJu_3fdzHafW9rdPGFL8Y0435gi0lCMcjR-SWB68mSFA/exec';
        const passwords = {
            'หลักสูตรสัญญาบัตร สายวิทยาการการศึกษา': {
                'การอนุมัติ1': '111111',
                'การอนุมัติ2': '222222',
                'การอนุมัติ3': '333333',
                'การอนุมัติ4': '444444'
            },
            'หลักสูตรประทวน สายวิทยาการการศึกษา': {
                'การอนุมัติ1': '111111',
                'การอนุมัติ2': '222222',
                'การอนุมัติ3': '333333',
                'การอนุมัติ4': '444444'
            },
            'หลักสูตรสัญญาบัตรใหม่': {
                'การอนุมัติ1': '111111',
                'การอนุมัติ2': '222222',
                'การอนุมัติ3': '8',
                'การอนุมัติ4':'55555'
            },
            'หลักสูตรประทวนใหม่': {
                'การอนุมัติ1': '111111',
                'การอนุมัติ2': '222222',
                'การอนุมัติ3': '333333',
                'การอนุมัติ4': '444444'
            },
            'หลักสูตรประทวนอาวุโส': {
                'การอนุมัติ1': 'aaaa',
                'การอนุมัติ2': 'pppp',
                'การอนุมัติ3': '333333',
                'การอนุมัติ4': '444444'
            },
            'หลักสูตรการปฏิบัติการร่วม': {
                'การอนุมัติ1': '111111',
                'การอนุมัติ2': '222222',
                'การอนุมัติ3': '333333',
                'การอนุมัติ4': '867903'
            },
            'หลักสูตรการปฏิบัติการร่วม-A': {
                'การอนุมัติ1': 'AAA111',
                'การอนุมัติ2': 'Joc010',
                'การอนุมัติ3': '726496',
                'การอนุมัติ4': '867903'
            },
            'หลักสูตรการปฏิบัติการร่วม-B': {
                'การอนุมัติ1': 'BBB111',
                'การอนุมัติ2': 'Joc010',
                'การอนุมัติ3': '867903',
                'การอนุมัติ4': '867903'
            },
            'หลักสูตรการปฏิบัติการร่วม-C': {
                'การอนุมัติ1': 'CCC111',
                'การอนุมัติ2': 'Joc010',
                'การอนุมัติ3': '086199',
                'การอนุมัติ4': '867903'
            },
            'หลักสูตรการปฏิบัติการร่วม-D': {
                'การอนุมัติ1': 'DDD111',
                'การอนุมัติ2': 'Joc010',
                'การอนุมัติ3': '005965',
                'การอนุมัติ4': '867903'
            }
        };
        
        

// Fetch all data on load
let allData = [];

window.onload = function() {
    fetchData();
};

function fetchData() {
    fetch(`${scriptURL}?getData=true`)
        .then(response => response.json())
        .then(data => {
            allData = data; // Store data globally for filtering
            displayCards(data); // Show all data initially
        })
        .catch(error => {
            document.getElementById("status").className = "alert alert-danger";
            document.getElementById("status").innerText = "Error fetching data.";
            console.error("Fetch error:", error);
        });
}



// Function to filter and display cards based on the selected course
function filterByCourse() {
    const courseName = document.getElementById('courseSelector').value;

    if (courseName === "") {
        // Show all data if no course is selected
        displayCards(allData);
    } else {
        // Filter data based on selected course
        const filteredData = allData.filter(row => row['หลักสูตร'] === courseName);
        displayCards(filteredData);
    }
}

        function displayCards(data) {
            const container = document.getElementById("dataCards");
            container.innerHTML = ''; // Clear previous contents

            if (!data || data.length === 0) {
                document.getElementById("status").className = "alert alert-warning";
                document.getElementById("status").innerText = "No data available.";
                return;
            }

            document.getElementById("status").className = "alert alert-success";
            document.getElementById("status").innerText = "การดาวน์โหลดเสร็จสมบูรณ์";

            data.forEach(row => {
                const card = document.createElement('div');
                card.className = `card ${determineBackgroundClass(row)}`;
                let cardBody = '<div class="card-body">';
                
                // (ลบฟังก์ชัน formatDateTimeToThai ที่ซ้ำซ้อนภายในนี้)
                // จะเรียกใช้ฟังก์ชันที่อยู่ด้านนอกแทน

                const startDate = row['ตั้งแต่วันที่'] ? formatDateToThai(row['ตั้งแต่วันที่']) : 'N/A';
                const endDate = row['ถึงวันที่'] ? formatDateToThai(row['ถึงวันที่']) : 'N/A';
                const Timestamp = row["Timestamp"] ? formatDateTimeToThai(row["Timestamp"]) : 'N/A';
                

                // Custom formatted display
                const formattedText = `
                        <p><strong>(${row['รหัสประจำตัว']}) ${row['ยศ']} ${row['ชื่อ']} ${row['สกุล']}</strong></p>
                        <p><strong>การขออนุญาต:</strong> ${row['การขออนุญาต']}</p>
                        <p><strong>ระยะเวลา:</strong> ${startDate} ถึง ${endDate}</p>
                        <p><strong>เหตุผลชี้แจง:</strong> ${row['เหตุผลชี้แจง']}</p>
                         <p><strong>Timestamp:</strong> ${Timestamp}</p>
                `;

                cardBody += formattedText;
                cardBody += `
                        <button type="button" class="btn btn-primary" data-record='${JSON.stringify(row)}' aria-label="Show record details" onclick="showDetails(this)">รายละเอียด</button>
                        <button type="button" class="btn btn-approval1" onclick="promptPassword('${row['Timestamp']}', '${row['ชื่อ']}', 'การอนุมัติ1')">หัวหน้าหมวด</button>
                        <button type="button" class="btn btn-approval2" onclick="promptPassword('${row['Timestamp']}', '${row['ชื่อ']}', 'การอนุมัติ2')">หัวหน้านักเรียน</button>
                        <button type="button" class="btn btn-approval3" onclick="promptPassword('${row['Timestamp']}', '${row['ชื่อ']}', 'การอนุมัติ3')">ที่ปรึกษาหมวด</button>
                        <button type="button" class="btn btn-approval4" onclick="promptPassword('${row['Timestamp']}', '${row['ชื่อ']}', 'การอนุมัติ4')">นายทหารปกครอง</button>
                `;
                cardBody += '</div>';
                card.innerHTML = cardBody;
                container.appendChild(card);
            });
        }

        function determineBackgroundClass(row) {
            if (row['การอนุมัติ4'] === true) return 'bg-approval4';
            if (row['การอนุมัติ3'] === true) return 'bg-approval3';
            if (row['การอนุมัติ2'] === true) return 'bg-approval2';
            if (row['การอนุมัติ1'] === true) return 'bg-approval1';
            return 'bg-none';
        }

        function promptPassword(timestamp, name, field) {
            const selectedCourse = document.getElementById('courseSelector').value;
        
            if (!selectedCourse || !passwords[selectedCourse]) {
                alert('กรุณาเลือกหลักสูตรที่ถูกต้องก่อน');
                return;
            }
        
            const correctPassword = passwords[selectedCourse][field];
            const enteredPassword = prompt(`ป้อนรหัสผ่านสำหรับ ${field} (${selectedCourse}):`);
        
            if (enteredPassword === correctPassword) {
                updateApproval(timestamp, name, field);
            } else {
                alert('รหัสไม่ถูกต้อง');
            }
        }
        
        

        function updateApproval(timestamp, name, field) {
            const updatePayload = {
                Timestamp: timestamp,
                ชื่อ: name.trim()
            };
            updatePayload[field] = true;
        
            fetch(`${scriptURL}?updateData=true&text=${encodeURIComponent(JSON.stringify(updatePayload))}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        alert(`อัพเดท ${field} สำเร็จ.`);
                        callSetRowColors();
        
                        // Fetch and filter data based on the selected course
                        const selectedCourse = document.getElementById('courseSelector').value;
                        if (selectedCourse === "") {
                            fetchData(); // Show all data if no course is selected
                        } else {
                            fetchAndFilterByCourse(selectedCourse);
                        }
                    } else {
                        alert(`Error: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error("Update error:", error);
                    alert("เกิดข้อผิดพลาดในการอัพเดทข้อมูล.");
                });
        }
        
        
        // New function to fetch and filter data by course
        function fetchAndFilterByCourse(courseName) {
            fetch(`${scriptURL}?getData=true`)
                .then(response => response.json())
                .then(data => {
                    allData = data; // Update global data
                    const filteredData = allData.filter(row => row['หลักสูตร'] === courseName);
                    displayCards(filteredData);
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    alert("เกิดข้อผิดพลาดในการค้นหา.");
                });
        }

        function callSetRowColors() {
            const url = 'https://script.google.com/macros/s/AKfycbxB_yMZJas6VtxF1nfIKHO2oAUrnwzBCBdj12Rmy6OkGNW0Lv3S_jggfVnzIEaMGhA3/exec';
            
            fetch(url, { method: 'GET' }) // Or 'POST' if required
                .then(response => response.text())
                .then(data => {
                    console.log("Set Row Colors Response:", data);
                    //alert("Row colors updated successfully.");
                })
                .catch(error => {
                    console.error("Error calling setRowColors:", error);
                    //alert("An error occurred while updating row colors.");
                });
        }

        function formatDateTimeToThai(dateTimeStr) {
            if (!dateTimeStr) return 'N/A';

            const date = new Date(dateTimeStr);
            if (isNaN(date.getTime())) return dateTimeStr;

            const thaiYear = date.getFullYear(); 
            const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${thaiYear}`;
            const formattedTime = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            return `${formattedDate} ${formattedTime}`;
        }

        // ======================================================
        // START: โค้ดที่แก้ไข
        // ======================================================
        function formatDateToThai(dateStr) {
            if (!dateStr) return 'N/A';
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            // ดึงค่าวัน/เดือน/ปี จาก UTC (Coordinated Universal Time)
            // เพื่อป้องกันการเลื่อนของวันที่จาก Timezone
            const day = date.getUTCDate();
            const month = date.getUTCMonth() + 1; // getUTCMonth() เริ่มที่ 0
            const year = date.getUTCFullYear();

            return `${day}/${month}/${year}`;
        }
        // ======================================================
        // END: โค้ดที่แก้ไข
        // ======================================================

        function formatTime(isoTime) {
            const time = new Date(isoTime);
            return time.toTimeString().substr(0, 5);
        }

        function showDetails(button) {
            const record = JSON.parse(button.getAttribute('data-record'));
            let details = '';
            for (let key in record) {
                let value = record[key];
                if (key === 'Timestamp') {
                    value = formatDateTimeToThai(value);
                } else if (key.includes('วันที่')) { // 'ตั้งแต่วันที่', 'ถึงวันที่'
                    value = formatDateToThai(value); // ใช้ฟังก์ชันที่แก้ไขแล้ว
                } else if (key.includes('เวลา')) {
                    value = formatTime(value);
                }
                details += `<strong>${key}:</strong> ${value}<br>`;
            }
            document.getElementById('modalContent').innerHTML = details;
            $('#detailModal').modal('show');
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
